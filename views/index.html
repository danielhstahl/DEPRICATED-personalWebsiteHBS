<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

  <!--<link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">-->
  <!--<script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>-->
  <!--<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>-->
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <!--<script src="/assets/js/highcharts-custom.js"></script>-->
  <script src='/socket.io/socket.io.js'></script>
  <script src="/assets/js/path.js"></script>


  <link rel="stylesheet" href="/assets/css/katex.min.css">
  <script src="/assets/js/katex.min.js"></script>

  <script src="/assets/js/prism.js"></script>
  <link href='/assets/css/prism.css' rel='stylesheet' />

  <script src="/assets/js/handlebars-v3.0.3.js"></script>
  <script src="/assets/js/mathjaxHelper.js"></script> <!--handlebars helper {{#mathjax}}{{/mathjax}}-->
  <link href="/assets/css/simple-sidebar.css" rel="stylesheet">
  <script src="/assets/templates/templates.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
  <style>
    h2 {
      font-family: 'Raleway', sans-serif;
    }

    .stockUp {
      color: green;
    }

    .stockDown {
      color: red;
    }

    .txt {
      font-family: 'Raleway', sans-serif;
      font-size: 125%;
    }

    .topScreen {
      margin-top: 30px;
    }

    .hidden {
      display: none;
    }

    .gridPadding {
      padding: 14px;
    }

    .avatar {
      height: 48px!important;
      width: 48px!important;
    }

    .middle {
      vertical-align: middle;
    }

    .container {
      max-width: 800px;
    }

    .icon {
      height: 48px;
      width: 48px;
      display: block;
    }

    .float-right {
      float: right;
    }

    .float-left {
      float: left;
    }

    .thumbnail {
      /*height:190px;*/
      overflow: hidden;
      height: 150px;
      /*overflow: auto;*/
    }

    .thumbnail img {
      /*height:150px;*/
      /*width:100%;*/
      max-width: none;
      height: 100%;
      /*background-size: 100% auto;*/
    }
    /*.fixedImageHeight{
      height:180px;
    }*/

    @media(max-width:767px) {
      /*for very small devices (phones) */
      #page-content-wrapper {
        padding: 0;
      }
      .topScreen {
        margin: 0;
        position: fixed;
        width: 100%;
      }
      #mainText {
        padding-top: 50px;
      }
      .thumbnail img {
        width: 100%;
        height: 100%;
        /*background-size: 100% auto;*/
      }
    }
    /*.github { mask: url(#localstyle); }*/
  </style>
</head>

<body id='wrapper'>

  <div id='sidebar-wrapper'>

  </div>
  <div id='page-content-wrapper'>
    <div class='container topScreen'>
      <div class='row holdIcons'>
        <div class='col-xs-3 holdMenu'>
          <img src='assets/icons/menu.svg' class='toggleSidebar icon float-left'>
        </div>
        <div class='col-xs-9 holdContact'>
          <img class="avatar icon float-right" src="/assets/images/avatar.png">
          <a href='https://www.linkedin.com/profile/view?id=AAIAAAYja3AB_fq6IhUtF5CBw1yjTHheP8YIooE&trk=nav_responsive_tab_profile'>
            <img src='assets/icons/linkedin.svg' class='icon float-right'>
          </a>
          <a href='https://plus.google.com/u/0/+DanielStahl1138'>
            <img src='assets/icons/googleplus.svg' class='icon float-right'>
          </a>
          <a href='https://github.com/phillyfan1138'>
            <img src='assets/icons/github.svg' class='icon float-right'>
          </a>
        </div>

      </div>
    </div>

    <div class='ui divider'></div>
    <div id='mainText'></div>


  </div>
</body>
<script>
  //  var crossroads=new Crossroads();
  Handlebars.registerHelper("debug", function(optionalValue) {
    console.log("Current Context");
    console.log("====================");
    console.log(this);

    if (optionalValue) {
      console.log("Value");
      console.log("====================");
      console.log(optionalValue);
    }
  });
  var socket = io();

  var chart = ""; //"global" chart variable
  Handlebars.partials = Handlebars.templates;
  var template = Handlebars.templates['textAreas'];
  var sidebarTemplate = Handlebars.templates['sidebar'];
  var stockTemplate = Handlebars.templates['stock'];
  var selectionTemplate = Handlebars.templates['createSelection'];
  var modal = Handlebars.templates['modal'];
  var siteObj = [{
    content: [{
      header: "Productivity",
      text: "productivity"
    }, {
      header: "Data Management",
      text: "dataManagement"
    }, {
      header: "Mathematical Modeling",
      text: "mathematicalModeling"
    }],
    route: "home",
    displayName: "Home"
  }, {
    content: [{
      header: "Summary",
      text: "summary"
    }, {
      header: "Skills",
      text: "skills"
    }, {
      header: "Analytics",
      text: "analytics"
    }, {
      header: "Model Risk",
      text: "modelRisk"
    }],
    route: "about",
    displayName: "About"
  }, {
    content: [{
      header: "Projects",
      text: "projects",
      projects: [{
        route: "projects/creditRisk",
        src: "assets/images/creditRisk.jpg",
        colMd: 4,
        content: [{
          text: "inputProject",
          input: [{
            label: "Number of Assets",
            placeholder: "100000",
            id: "n"
          }, {
            label: "Time Horizon",
            placeholder: "1",
            id: "t"
          }, {
            label: "X0",
            placeholder: "1",
            id: "X0"
          }, {
            label: "Systemic Drift",
            placeholder: ".1",
            id: "alpha"
          }, {
            label: "Systemic Volatility",
            placeholder: ".3",
            id: "sigma"
          }, {
            label: "Portfolio Return",
            placeholder: ".05",
            id: "alph"
          }, {
            label: "q",
            placeholder: ".05",
            id: "q"
          }, {
            label: "lambda",
            placeholder: ".05",
            id: "lambda"
          }, {
            label: "Number of steps in X",
            placeholder: "1024",
            id: "h"
          }, {
            label: "Number of steps in U",
            placeholder: "128",
            id: "k"
          }],
          chartId: "creditRisk",
          hasOptions: false,
          submitId: "projects/creditRisk"
        }]
      }, {
        route: "projects/operationalRisk",
        src: "assets/images/operationalRisk.jpg",
        colMd: 4,
        content: [{
          text: "inputProject",
          input: [{
            label: "Time Horizon",
            placeholder: "1",
            id: "t"
          }, {
            label: "Speed of mean reversion of frequency distribution",
            placeholder: ".4",
            id: "a"
          }, {
            label: "Volatility of frequency distribution",
            placeholder: ".4",
            id: "sigma"
          }, {
            label: "Level of frequency distribution",
            placeholder: "10",
            id: "lambda"
          }, {
            label: "Shape parameter of severity distribution",
            placeholder: "10",
            id: "c"
          }, {
            label: "Scale parameter of severity distribution",
            placeholder: "5",
            id: "d"
          }, {
            label: "Correlation between jumps and time",
            placeholder: ".5",
            id: "delta"
          }, {
            label: "Starting value of frequency",
            placeholder: "1",
            id: "v0"
          }, {
            label: "Steps in ODE",
            placeholder: "128",
            id: "n"
          }, {
            label: "Steps in X",
            placeholder: "1024",
            id: "k"
          }, {
            label: "Steps in U",
            placeholder: "256",
            id: "l"
          }],
          chartId: "operationalRisk",
          hasOptions: false,
          submitId: "projects/operationalRisk"
        }]
      }, {
        route: "projects/firstHittingTime",
        src: "assets/images/stock-price.jpg",
        colMd: 4,
        content: [{
          text: "inputProject",
          input: [{
            label: "Value To Hit",
            placeholder: "5",
            id: "m"
          }, {
            label: "alpha",
            placeholder: ".1",
            id: "alpha"
          }, {
            label: "sigma",
            placeholder: ".3",
            id: "sigma"
          }, {
            label: "delta",
            placeholder: ".8",
            id: "delta"
          }, {
            label: "Steps in U",
            placeholder: "256",
            id: "n"
          }, {
            label: "Steps in T",
            placeholder: "512",
            id: "k"
          }, {
            label: "Steps in X",
            placeholder: "300",
            id: "l"
          }],
          chartId: "firstHittingTime",
          hasOptions: true,
          submitId: "projects/firstHittingTime" //this is used for communitcateing with server
        }]
      }],


    }],
    route: "projects",
    displayName: "Projects"
  }];
  iterate(siteObj);

  function iterate(val) {
    var n = val.length;
    for (var i = 0; i < n; i++) {
      var record = val[i];
      createContent(record);
      var subRecord = record.content;
      var m = subRecord.length;
      for (var j = 0; j < m; j++) {
        if (subRecord[j][record.route]) { //if additional pages defined through route
          iterate(subRecord[j][record.route]);
        }
      }
    }
  }

  function createContent(record) {
    Path.map("#/" + record.route).to(function() {
      var $mainText = $('#mainText');
      $mainText.html("");
      var subRecord = record.content;
      var m = subRecord.length;
      for (var j = 0; j < m; j++) {
        var html = template(subRecord[j]);
        $mainText.append(html);
      }
      traverseDom();
    });
  }
  $('#sidebar-wrapper').html(sidebarTemplate({
    data: siteObj
  }));
  //Path.rescue("#/home");
  Path.root("#/home");
  Path.listen();
  $('.big.icon').click(function(e) {
    $('.sidebar').sidebar('setting', 'dimPage', false).sidebar('toggle');
  });

  function traverseDom() { //gets any stock value and age
    $('.stock').each(function() {
      var $element = $(this);
      var ticker = $element.attr('id');
      getStock(ticker, $element);
    });
    $('#age').html(getAge());

    function getAge() {
      var birthday = new Date("4/10/1989");
      var ageDifMs = Date.now() - birthday.getTime();
      var ageDate = new Date(ageDifMs); // miliseconds from epoch
      return Math.abs(ageDate.getUTCFullYear() - 1970);
    }
  }

  function getStock(stock, element) { //get stock values from name
    $.ajax({
      url: '/stock',
      method: 'post',
      data: JSON.stringify({
        stock: stock
      }),
      contentType: 'application/json',
      success: function(data) {
        data = data.replace(/\//g, "");
        data = JSON.parse(data)[0];
        console.log(data);
        var objForTemplate = {
          symbol: data.t,
          price: data.l,
          change: data.c,
          up: data.c.substring(0, 1) !== '-'
        }
        var html = stockTemplate(objForTemplate);
        element.prepend(html);
      }

    });

  }
  $('.toggleSidebar').click(function(e) {
    $('#wrapper').toggleClass('toggled');
  });

  $('#mainText').on('click', '#execute', function(e) { //if project "Submit" is clicked
    $('.progress').removeClass('hidden');
    var attributes = {};
    $('.projectInput').each(function() {
      var $ths = $(this);
      var id = $ths.attr('id');
      attributes[id] = $ths.val();
      var nbr = Number(attributes[id]);
      if (!nbr) {
        attributes[id] = Number($ths.attr('placeholder'));
      } else {
        attributes[id] = Number(attributes[id]);
      }
    });
    var expressRoute = $(this).attr('data-route').split("/");
    socket.emit(expressRoute[0], {
      file: expressRoute[1],
      attributes: attributes
    });

  });
  socket.on('update', function(data) {
    $('#progressBar').css("width", data);
  });
  socket.on('result', function(data) {
    chart="";
    $('#progressBar').css("width", '0%');
    $('.progress').addClass('hidden');
    console.log(data);
    if (data.y) { //then no "options"
      createChart(data);
    } else { //has options, show on screen
      var options = Object.keys(data);
      var $select = $('#selection');
      options.sort();
      $select.html(selectionTemplate({keys:options})); //select a chart
      $select.on('click', '.selectSeries', function(e) {
        e.preventDefault();
        handleSeriesClick(data, this);
      });
    }
  });

  function createChart(data) {
    if (isNaN(data.y[0]) || Math.abs(data.y[0]) > 100) { //something bad happened in the algorithm...
      console.log("problem!");
    } else {
      var n = data.x.length;
      var nMin = 0;
      var nMax = n - 1;
      var yMin = data.yMax * .003; //since otherwise long lead in, lead out
      while (data.y[nMin] < yMin) {
        nMin++;
      }
      while (data.y[nMax] < yMin) {
        nMax--;
      }
      var xAxis = data.x.slice(nMin, nMax + 1);
      var yAxis = data.y.slice(nMin, nMax + 1);
      $('#chartist').empty();
      chart = new Highcharts.Chart({
        chart: {
          type: 'spline',
          renderTo: 'chartist',
          zoomType: 'x'
        },
        title: {
          text: ""
        },
        credits: {
          enabled: false
        },
        xAxis: {
          categories: xAxis,
          labels: {
            formatter: function() {
              return Highcharts.numberFormat(this.value, 2, ".", ",");
            }
          }
        },
        yAxis: {
          min: 0
        },
        legend: {
          enabled: false
        },
        plotOptions: {
          spline: {
            lineWidth: 2,
            states: {
              hover: {
                lineWidth: 4
              }
            },
            marker: {
              enabled: false
            }
          }
        },
        series: [{
          name: 'density',
          data: yAxis
        }]
      });
    }
  }

  function handleSeriesClick(data, self) {
    var attr = $(self);
    var remove = false;
    if (attr.hasClass('active')) {
      remove = true;
      attr.removeClass('active');
    } else {
      attr.addClass('active');
    }
    var value = attr.text();
    if (remove) {
      var numSeries = chart.series.length;
      console.log(chart.series);
      for (var i = 0; i < numSeries; i++) {
        if (chart.series[i].name === value) { //inefficient, but until the series gets a hashmap...
          chart.series[i].remove();
          break;
        }
      }
    } else {
      if (chart) {
        chart.addSeries({
          name: value,
          data: data[value].y
        });
      } else {
        createChart(data[value]);
      }
    }
  }
  $('#mainText').on('click', '#projectHelp', function(e){
    var mdl=modal({text:'creditRiskResearch'});
    console.log($(mdl)[2]);
    $($(mdl)[2]).modal('show')
  });
</script>



</html>
